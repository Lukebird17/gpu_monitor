# GPU监控系统 - 快速使用指南（无需sudo权限）

## 🚀 快速开始

### 第一步：安装依赖（只需运行一次）

```bash
cd /home/honglianglu/ssd/gpu_monitor
./install_gpu_monitor.sh
```

按照提示选择：
- **选项1**: 如果这台机器要作为监控服务端（显示Web界面）
- **选项2**: 如果这台机器只运行客户端（收集GPU数据）
- **选项3**: 同时安装服务端和客户端

### 第二步：启动监控

#### 方法A: 使用安装脚本生成的后台运行脚本（推荐）

**启动服务端：**
```bash
./run_server_background.sh
```
访问 `http://服务器IP:5000` 查看监控页面

**启动客户端（在每台GPU服务器上）：**
```bash
./run_client_background.sh
```

#### 方法B: 手动后台启动

**服务端：**
```bash
nohup python3 gpu_monitor_server.py --port 5000 > gpu_server.log 2>&1 &
echo $! > gpu_server.pid
```

**客户端：**
```bash
nohup python3 gpu_monitor_client.py \
  --server http://服务端IP:5000 \
  --name "服务器名称" \
  > gpu_client.log 2>&1 &
echo $! > gpu_client.pid
```

#### 方法C: 前台运行（测试用）

**服务端：**
```bash
python3 gpu_monitor_server.py --port 5000
```

**客户端：**
```bash
python3 gpu_monitor_client.py --server http://服务端IP:5000 --name "GPU服务器1"
```

## 📊 管理命令

### 使用管理脚本（最简单）
```bash
./manage_monitor.sh
```
交互式菜单包含：查看状态、停止服务、重启、查看日志等

### 常用命令

**查看运行状态：**
```bash
ps aux | grep gpu_monitor
```

**查看日志：**
```bash
tail -f gpu_server.log  # 服务端日志
tail -f gpu_client.log  # 客户端日志
```

**停止服务：**
```bash
# 停止服务端
kill $(cat gpu_server.pid)

# 停止客户端
kill $(cat gpu_client.pid)

# 停止所有
pkill -f gpu_monitor
```

**重启服务：**
```bash
./manage_monitor.sh  # 选择重启选项
```

## 🌐 访问监控页面

启动服务端后，在浏览器中访问：
```
http://服务器IP:5000
```

页面会每5秒自动刷新，显示所有服务器的GPU信息。

## 📝 配置示例

### 场景1: 单台服务器（服务端和客户端在同一台机器）

```bash
# 安装
./install_gpu_monitor.sh
# 选择 3 (同时安装服务端和客户端)

# 启动服务端
./run_server_background.sh

# 启动客户端
./run_client_background.sh
# 服务端地址填: http://localhost:5000
```

### 场景2: 多台服务器

**在服务端机器上（192.168.1.100）：**
```bash
./install_gpu_monitor.sh  # 选择 1
./run_server_background.sh
```

**在每台GPU服务器上：**
```bash
./install_gpu_monitor.sh  # 选择 2

# 修改run_client_background.sh中的服务端地址，或手动启动：
nohup python3 gpu_monitor_client.py \
  --server http://192.168.1.100:5000 \
  --name "GPU服务器-$(hostname)" \
  > gpu_client.log 2>&1 &
echo $! > gpu_client.pid
```

## 🔧 故障排查

### 问题1: pip安装失败
```bash
# 尝试使用python -m pip
python3 -m pip install --user flask requests

# 或者指定清华源
pip3 install --user -i https://pypi.tuna.tsinghua.edu.cn/simple flask requests
```

### 问题2: 客户端无法连接服务端
```bash
# 1. 检查服务端是否运行
ps aux | grep gpu_monitor_server

# 2. 测试网络连接
curl http://服务端IP:5000

# 3. 检查防火墙（如果有权限）
# 或者联系管理员开放5000端口

# 4. 查看客户端日志
tail -f gpu_client.log
```

### 问题3: 进程意外停止
```bash
# 查看日志找原因
tail -50 gpu_server.log
tail -50 gpu_client.log

# 重启服务
./manage_monitor.sh  # 选择重启选项
```

### 问题4: 服务器显示"离线"
- 检查客户端是否正在运行: `ps aux | grep gpu_monitor_client`
- 查看客户端日志: `tail gpu_client.log`
- 服务器超过60秒未收到数据会标记为离线

## 📁 重要文件说明

| 文件 | 说明 |
|------|------|
| `gpu_monitor_server.py` | 服务端主程序 |
| `gpu_monitor_client.py` | 客户端主程序 |
| `install_gpu_monitor.sh` | 安装脚本 |
| `manage_monitor.sh` | 管理脚本 |
| `run_server_background.sh` | 服务端后台启动脚本（安装时生成）|
| `run_client_background.sh` | 客户端后台启动脚本（安装时生成）|
| `gpu_server.pid` | 服务端进程ID |
| `gpu_client.pid` | 客户端进程ID |
| `gpu_server.log` | 服务端日志 |
| `gpu_client.log` | 客户端日志 |

## 💡 使用技巧

### 1. 在screen中运行（推荐）
```bash
# 创建screen会话
screen -S gpu_server
python3 gpu_monitor_server.py --port 5000
# 按 Ctrl+A 然后 D 退出screen

# 恢复会话
screen -r gpu_server

# 查看所有会话
screen -ls
```

### 2. 设置别名（方便使用）
在 `~/.bashrc` 中添加：
```bash
alias gpu-status='cd ~/ssd/gpu_monitor && ./manage_monitor.sh'
alias gpu-log-server='tail -f ~/ssd/gpu_monitor/gpu_server.log'
alias gpu-log-client='tail -f ~/ssd/gpu_monitor/gpu_client.log'
```

然后运行：
```bash
source ~/.bashrc
```

### 3. 开机自动启动（使用crontab）
```bash
crontab -e
```

添加以下行：
```
@reboot sleep 10 && cd /home/honglianglu/ssd/gpu_monitor && ./run_client_background.sh
```

### 4. 监控多个端口
如果需要运行多个服务端（不同端口）：
```bash
# 端口5000
nohup python3 gpu_monitor_server.py --port 5000 > gpu_server_5000.log 2>&1 &

# 端口5001
nohup python3 gpu_monitor_server.py --port 5001 > gpu_server_5001.log 2>&1 &
```

## 🔒 安全建议

1. **修改默认端口**: 使用非标准端口增加安全性
2. **限制访问**: 仅在内网使用，不要暴露到公网
3. **使用SSH隧道**: 如果需要远程访问
   ```bash
   ssh -L 5000:localhost:5000 user@server
   ```
4. **定期查看日志**: 检查异常访问

## ❓ 常见问题

**Q: 忘记运行在哪个端口了？**
```bash
ps aux | grep gpu_monitor_server | grep -o "port [0-9]*"
# 或者
netstat -tlnp | grep python3
```

**Q: 如何查看所有连接的服务器？**
访问 `http://服务器IP:端口/api/data` 可以获取JSON格式的所有数据

**Q: 可以同时监控多个集群吗？**
可以！在每个集群部署一个服务端，或者所有客户端连接到同一个服务端

**Q: 内存占用如何？**
- 服务端: 约30-50MB
- 客户端: 约10-20MB
- 网络流量: 每次更新约1-5KB

## 📞 需要帮助？

查看详细文档：`GPU_MONITOR_README.md`

---

**最后更新**: 2024-11-08
**版本**: 1.0 (无sudo版本)


